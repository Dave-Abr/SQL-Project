![Amazon](data/amazon_cover.jpg)

## Project Overview

This project involves advanced querying including customer behavior, product performance, and sales trends, revenue analysis, customer segmentation, and inventory management, addressing real-world business challenges.

**Resource**: [`01_database_init.sql`](01_database_init.sql), [`02_business_queries.sql`](02_business_queries.sql)





## Database Setup

Created tables for `products`, `categories`, `customers`, `sellers`, `orders`, `orders_items`, `payments`, `shipping` and `inventory`.

![AmazonERD](00_database_erd.jpg)


```sql

CREATE TABLE products
	(
	product_id INT PRIMARY KEY,
	product_name VARCHAR(50),
	price FLOAT,
	cogs FLOAT,
	category_id INT,
	CONSTRAINT product_fk_category 
	FOREIGN KEY (category_id)
	REFERENCES categories(category_id)
	);

CREATE TABLE orders
	(
	order_id INT PRIMARY KEY,
	order_date DATE,
	customer_id INT,
	seller_id INT,
	order_status VARCHAR(15),
	CONSTRAINT order_fk_customer_id
	FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
	CONSTRAINT order_fk_seller_id
	FOREIGN KEY (seller_id) REFERENCES sellers(seller_id)
	);

[...]

```

## Business Problems

**1. Top Selling Products**

Query the top 10 products by total sales value.
Challenge: Include product id, product name, total quantity sold, and total sales value.

```sql
SELECT 
	products.product_id,
	products.product_name,
	SUM(orders_items.quantity) AS total_quantity,
	COUNT(orders.order_id) AS total_orders,
	SUM(orders_items.total_price) AS total_price
FROM
	orders
JOIN orders_items
	ON orders_items.order_id = orders.order_id
JOIN products
	ON products.product_id = orders_items.product_id
GROUP BY 1,2
ORDER BY 5 DESC
;

```
**2. Revenue by Category**

Calculate total revenue generated by each product category.
Challenge: Include the percentage contribution of each category to total revenue.

```sql
SELECT 
	categories.category_name,
	ROUND(SUM(orders_items.total_price)::numeric,0) as total_sales,
	ROUND((SUM(orders_items.total_price) /
	(SELECT SUM(total_price) FROM orders_items))::numeric,2) as  percentage
FROM orders
JOIN orders_items
	ON orders.order_id = orders_items.order_id
JOIN products
	ON orders_items.product_id = products.product_id
JOIN categories
	ON products.category_id = categories.category_id
GROUP BY 1
ORDER BY 2 DESC;
```
**3. Average Order Value (AOV)**

Compute the average order value for each customer.
Challenge: Include only customers with more than 5 orders.

```sql
SELECT 
	customers.customer_id,
	CONCAT(customers.first_name, ' ',customers.last_name) as full_name,
	COUNT(orders.order_id) as cnt_orders,
	ROUND(SUM(total_price)::numeric,0) as total_sales,
	SUM(total_price)/ COUNT(orders.order_id) as avg_orders
FROM orders
JOIN orders_items
	ON orders.order_id = orders_items.order_id
JOIN customers
	ON orders.customer_id = customers.customer_id
GROUP BY 1,2
HAVING COUNT(orders.order_id) > 5
ORDER BY 5
;
```
**4. Monthly Sales Trend:**

Query monthly total sales over the past year.
Challenge: Display the sales trend, grouping by month, return current_month sale, last month sale!

```sql
SELECT
	year,
	month,
	total_sales,
	LAG(total_sales,1) OVER(ORDER BY year,month) 
FROM
(
SELECT 
	EXTRACT(YEAR FROM order_date) as year,
	EXTRACT(MONTH FROM order_date) as month,
	ROUND(SUM(total_price::numeric),0) AS total_sales
FROM orders
JOIN orders_items
	ON orders.order_id = orders_items.order_id
GROUP BY 1,2
ORDER BY 1,2
)as c1;
```

**5. Customers with No Purchases**

Find customers who have registered but never placed an order.
Challenge: List customer details and the time since their registration.

```sql
SELECT *
FROM customers
WHERE customer_id NOT IN (SELECT DISTINCT(customer_id) FROM orders);
```

**6. Least-Selling Categories by State**

Identify the least-selling product category for each state.
Challenge: Include the total sales for that category within each state.

```sql
WITH ranking_table
AS
(SELECT
	customers.state,
	categories.category_name,
	SUM(orders_items.total_price) AS total_sales,
	RANK() OVER(PARTITION BY customers.state ORDER BY SUM(orders_items.total_price) ASC) AS rank
FROM orders
JOIN orders_items
	ON orders.order_id = orders_items.order_id
JOIN products
	ON orders_items.product_id = products.product_id
JOIN categories
	ON products.category_id = categories.category_id
JOIN customers
	ON orders.customer_id = customers.customer_id
GROUP BY 1,2
ORDER BY 1) 

SELECT * FROM ranking_table 
WHERE rank = 1 ;
```


**7. Customer Lifetime Value (CLTV)**

Calculate the total value of orders placed by each customer over their lifetime.
Challenge: Rank customers based on their CLTV.

```sql
SELECT 
	customers.customer_id,
	CONCAT(customers.first_name, ' ',customers.last_name),
	ROUND(SUM(total_price)::numeric,0) AS  total_sales,
	DENSE_RANK()OVER(ORDER BY SUM(total_price) DESC ) AS ranking
FROM orders
JOIN orders_items
	ON orders.order_id = orders_items.order_id
JOIN customers
	ON orders.customer_id = customers.customer_id
GROUP BY 1,2
ORDER BY 3 DESC;
```

**8. Inventory Stock Alerts**
   
Query products with stock levels below a certain threshold (e.g., less than 5 units).
Challenge: Include last restock date and warehouse information.

```sql
SELECT
	p.product_id AS product_id,
	p.product_name AS product_name,
	i.inventory_id AS inventory_id,
	i.stock AS stock,
	i.warehouse_id AS warehouse_id,
	i.last_stock_date AS last_stock_date
FROM products AS p
JOIN inventory AS i
ON i.product_id = p.product_id
WHERE i.stock < 10;
```

```sql
CALL update_status('RS138', 'IS135', 'Good');
```

6. **Branch Performance Report**
   
Create a query that generates a performance report for each branch, showing the number of books issued, the number of books returned, and the total revenue generated from book rentals.:

```sql
SELECT 
	br.branch_id,
	COUNT(i.issue_id),
	COUNT(r.return_id),
	SUM(b.rental_price)
FROM issue_status as i
JOIN employees as e
	ON i.issued_emp_id = e.emp_id
JOIN branch as br
	ON br.branch_id = e.branch_id
LEFT JOIN return_status as r
	ON r.issued_id = i.issue_id
JOIN books as b
	ON b.isbn = i.issued_book_isbn
GROUP BY br.branch_id;
```
